import{CREATE_CART_MUTATION,FETCH_CART_QUERY,ADD_TO_CART_MUTATION,REMOVE_FROM_CART_MUTATION,UPDATE_CART_LINE_MUTATION,UPDATE_DISCOUNT_CODE_MUTATION,CART_ATTRIBUTES_UPDATE_MUTATION,CART_BUYER_IDENTITY_UPDATE_MUTATION}from"./shopifyApi.js";const cartDrawer=document.getElementById("cart-drawer"),cartOverlay=document.getElementById("cart-overlay"),closeCartBtn=document.getElementById("close-cart-btn"),cartItemsContainer=cartDrawer.querySelector(".cart-items-container"),emptyCartMessage=document.getElementById("empty-cart-message"),cartSubtotalElement=document.getElementById("cart-subtotal"),checkoutBtn=document.getElementById("checkout-btn"),initialDiscountAmountElement=document.getElementById("initial-discount-amount"),cartLoadingOverlay=document.getElementById("cart-loading-overlay"),cartErrorContainer=document.getElementById("cart-error"),cartErrorMessage=document.getElementById("cart-error-message"),aliaDiscountSection=document.getElementById("alia-discount-section"),aliaRewardTextElement=document.getElementById("alia-reward-text"),aliaDiscountCodeElement=document.getElementById("alia-discount-code"),aliaTimerElement=document.getElementById("alia-timer"),aliaExpiredMessageElement=document.getElementById("alia-expired-message");let cart=null,aliaTimerInterval=null,isLoading=!1,elevarCartInitialized=!1,previousActiveElement=null;function getSelectedVariantId(){const t=document.querySelector('input[name="bundle"]:checked');if(t){const e=t.closest("label").getAttribute("data-variant-id");if(e)return e}const e=document.querySelector("label[data-variant-id]");if(e){const t=e.getAttribute("data-variant-id");if(t)return t}return console.error("Could not find any variant ID in bundle options."),null}const UVLIZER_PREFIX="trylumiclean_",CART_ID_STORAGE_KEY=`${UVLIZER_PREFIX}cart_id`,ALIA_CODE_STORAGE_KEY=`${UVLIZER_PREFIX}alia_discount_code`,ALIA_TEXT_STORAGE_KEY=`${UVLIZER_PREFIX}alia_reward_text`,ALIA_EXPIRY_STORAGE_KEY=`${UVLIZER_PREFIX}alia_expiry_timestamp`;function getUrlParameters(){const t=new URLSearchParams(window.location.search),e=["utm_source","utm_medium","utm_campaign","utm_term","utm_content","ref","gclid","fbclid"],r=[],a=["email","phone","firstname","lastname","address","zip","postcode","ssn","password"];return t.forEach(((t,n)=>{const o=n.toLowerCase();e.includes(o)&&!a.includes(o)&&t&&n.length<=50&&t.length<=250&&r.push({key:n,value:t})})),r}async function callShopifyAPI(t,e={}){setLoading(!0);try{const r=await fetch("/.netlify/functions/shopify-proxy",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:t,variables:e})});if(!r.ok){const t=await r.text();throw new Error(`Function call failed with status ${r.status}. ${t}`)}const a=await r.json();if(a.errors)throw new Error(`GraphQL error: ${a.errors[0].message}`);if(!a||void 0===a.data){const t=a&&a.details?JSON.stringify(a.details):"Unknown error structure";throw new Error(`Invalid or unexpected response from API proxy: ${t}`)}if(a.errors){const t=a.errors[0]?.message||"Unknown GraphQL error";throw new Error(`GraphQL error: ${t}`)}const n=Object.keys(a.data||{});if(n.length>0){const t=n[0],e=a.data[t];if(e&&e.userErrors&&e.userErrors.length>0)throw new Error(`Shopify error: ${e.userErrors[0].message}`)}return a.data}catch(t){let e="An unknown error occurred during the API call.";throw t instanceof Error?e=t.message:"string"==typeof t&&(e=t),new Error(e)}finally{setLoading(!1)}}function setLoading(t){isLoading=t,cartLoadingOverlay&&(t?cartLoadingOverlay.classList.remove("hidden"):cartLoadingOverlay.classList.add("hidden")),document.body.style.cursor=t?"wait":"default",checkoutBtn.disabled=t||cart&&0===cart.totalQuantity,checkoutBtn.classList.toggle("opacity-50",t||cart&&0===cart.totalQuantity),cartItemsContainer.querySelectorAll(".remove-item-btn, .quantity-btn").forEach((e=>e.disabled=t))}function showCartError(t,e=5e3){window.cartErrorTimeout&&(clearTimeout(window.cartErrorTimeout),window.cartErrorTimeout=null),cartErrorMessage&&cartErrorContainer?(cartErrorMessage.textContent=t,cartErrorContainer.classList.remove("hidden"),setTimeout((()=>{cartErrorContainer.classList.add("visible"),"undefined"!=typeof lucide&&lucide.createIcons({nodes:cartErrorContainer.querySelectorAll("[data-lucide]")})}),10),e>0&&(window.cartErrorTimeout=setTimeout((()=>{hideCartError()}),e))):alert(t)}function hideCartError(){cartErrorContainer&&(cartErrorContainer.classList.remove("visible"),setTimeout((()=>{cartErrorContainer.classList.add("hidden")}),300))}function createElevarProductObj(t,e=!0){let r=t.merchandise?.price?.amount,a=t.merchandise?.compareAtPrice?.amount,n=19900,o=24900;try{if("number"==typeof r)n=Number.isInteger(r)?r:Math.round(100*r);else if("string"==typeof r){const t=parseFloat(r);isNaN(t)||(n=r.includes(".")?Math.round(100*t):parseInt(r,10))}}catch(t){}try{if("number"==typeof a)o=Number.isInteger(a)?a:Math.round(100*a);else if("string"==typeof a){const t=parseFloat(a);o=isNaN(t)?n:a.includes(".")?Math.round(100*t):parseInt(a,10)}else o=n}catch(t){console.warn("[Elevar Helper] Error processing compareAtPrice:",a,t),o=n}const i={id:t.merchandise?.product?.handle||"",name:t.merchandise?.product?.title||"",brand:"TryLumiClean",category:"Home & Garden",variant:t.merchandise?.title||"",price:(n/100).toFixed(2),product_id:t.merchandise?.product?.id?.substring(t.merchandise.product.id.lastIndexOf("/")+1)||"",variant_id:t.merchandise?.id?.substring(t.merchandise.id.lastIndexOf("/")+1)||"",compare_at_price:(o/100).toFixed(2),image:t.merchandise?.image?.url||"",list:location.pathname};return e&&void 0!==t.quantity?i.quantity=t.quantity.toString():e&&(i.quantity="1"),i}function createElevarImpressionObj(t,e){let r=t.merchandise?.price?.amount,a=t.merchandise?.compareAtPrice?.amount,n=19900,o=24900;try{if("number"==typeof r)n=Number.isInteger(r)?r:Math.round(100*r);else if("string"==typeof r){const t=parseFloat(r);isNaN(t)||(n=r.includes(".")?Math.round(100*t):parseInt(r,10))}}catch(t){}try{if("number"==typeof a)o=Number.isInteger(a)?a:Math.round(100*a);else if("string"==typeof a){const t=parseFloat(a);o=isNaN(t)?n:a.includes(".")?Math.round(100*t):parseInt(a,10)}else o=n}catch(t){console.warn("[Elevar Helper] Error processing impression compareAtPrice:",a,t),o=n}return{id:t.merchandise?.product?.handle||"",name:t.merchandise?.product?.title||"",brand:"TryLumiClean",category:"Home & Garden",variant:t.merchandise?.title||"",price:(n/100).toFixed(2),quantity:t.quantity?t.quantity.toString():"1",product_id:t.merchandise?.product?.id?.substring(t.merchandise.product.id.lastIndexOf("/")+1)||"",variant_id:t.merchandise?.id?.substring(t.merchandise.id.lastIndexOf("/")+1)||"",compare_at_price:(o/100).toFixed(2),image:t.merchandise?.image?.url||"",position:e+1}}function onMidaReady(t){window.mida?t():window.mfunc.push(t)}function initializeElevar(){elevarCartInitialized||onMidaReady((()=>{if(window.mida&&window.mida.isRedirect)return;window.ElevarDataLayer=window.ElevarDataLayer||[];const t=cart?.lines?.nodes.map((t=>createElevarProductObj(t,!0)))||[];let e=cart?.cost?.totalAmount?.amount,r=0;try{if("number"==typeof e)r=Number.isInteger(e)?e:Math.round(100*e);else if("string"==typeof e){const t=parseFloat(e);isNaN(t)||(r=e.includes(".")?Math.round(100*t):parseInt(e,10))}}catch(t){}const a={event:"dl_user_data",cart_total:(r/100).toFixed(2),user_properties:{visitor_type:"guest"},ecommerce:{currencyCode:cart?.cost?.totalAmount?.currencyCode||"USD",cart_contents:{products:t}}};window.ElevarDataLayer.push(a),elevarCartInitialized=!0,triggerViewItemEvent()}))}function triggerViewItemEvent(){if(!window.ElevarDataLayer)return;const t=document.querySelector("[data-current-price]"),e=document.querySelector("[data-compare-price]"),r={id:"uvo-powered-home-disinfection-tower-new",name:"UVO254â„¢ -  Powered Home Disinfection Tower",brand:"TryLumiClean",category:"Home & Garden",variant:"Default Title",price:t?.innerText.match(/\d+(\.\d+)?/)?.[0]||"199.00",product_id:"8000627572985",variant_id:"44103628357881",compare_at_price:e?.innerText.match(/\d+(\.\d+)?/)?.[0]||"249.00",image:"https://www.uvlizer.us/cdn/shop/files/Uv1_d65306eb-669a-4b43-9fc9-ad8f3a15c0ba_900x.png?v=1713433283",list:location.pathname},a={event:"dl_view_item",user_properties:{visitor_type:"guest"},ecommerce:{currencyCode:"USD",detail:{actionField:{list:location.pathname,action:"detail"},products:[r]}}};window.ElevarDataLayer.push(a)}async function getOrCreateCart(){let t=null;try{t=localStorage.getItem(CART_ID_STORAGE_KEY)}catch(t){console.warn("LocalStorage access error when getting cart ID:",t)}if(t)try{const e=await callShopifyAPI(FETCH_CART_QUERY,{cartId:t});if(e&&e.cart)return cart=e.cart,cart;t=null;try{localStorage.removeItem(CART_ID_STORAGE_KEY)}catch(t){console.warn("LocalStorage access error when removing cart ID:",t)}}catch(e){showCartError("Could not retrieve your existing cart. Please try again."),t=null;try{localStorage.removeItem(CART_ID_STORAGE_KEY)}catch(t){console.warn("LocalStorage access error when removing cart ID after fetch error:",t)}}if(!t)try{const t=getUrlParameters(),e=30;let r=t.slice(0,e);t.length>e&&console.warn(`[Cart Init] Too many URL parameters (${t.length}). Truncated to first ${e}.`);const a={cartInput:{lines:[],attributes:r}},n=await callShopifyAPI(CREATE_CART_MUTATION,a);if(n&&n.cartCreate&&n.cartCreate.cart){cart=n.cartCreate.cart;try{localStorage.setItem(CART_ID_STORAGE_KEY,cart.id)}catch(t){console.warn("LocalStorage access error when saving new cart ID:",t)}return cart}{const t=n?.cartCreate?.userErrors;throw t&&t.length>0?(showCartError(`Cart Error: ${t[0].message}`),new Error(`Shopify User Error: ${t[0].message}`)):new Error("Cart creation failed unexpectedly. Check network logs.")}}catch(t){return t.message.startsWith("Shopify User Error:")||showCartError("Could not create a shopping cart. Please refresh and try again."),null}return cart}async function addCartLine(t,e,r=1){if(!e)return cart;const a=JSON.parse(JSON.stringify(cart)),n=await callShopifyAPI(ADD_TO_CART_MUTATION,{cartId:t,lines:[{merchandiseId:e,quantity:r}]}),o=n?.cartLinesAdd?.cart;if(o&&window.ElevarDataLayer){const t=o.lines.nodes.find((t=>{const e=a?.lines?.nodes.find((e=>e.merchandise.id===t.merchandise.id));return!e||t.quantity>e.quantity}));if(t){const e=createElevarProductObj(t,!0),r=a?.lines?.nodes.find((e=>e.merchandise.id===t.merchandise.id)),n=r?t.quantity-r.quantity:t.quantity;e.quantity=n.toString(),e.list=location.pathname;const i={event:"dl_add_to_cart",user_properties:{visitor_type:"guest"},ecommerce:{currencyCode:o.cost?.totalAmount?.currencyCode||"USD",add:{actionField:{list:location.pathname},products:[e]}}};window.ElevarDataLayer.push(i)}}return o}async function removeCartLine(t,e){let r=null;if(cart&&window.ElevarDataLayer){const t=cart.lines.nodes.find((t=>t.id===e));t&&(r=createElevarProductObj(t,!0),r.quantity=t.quantity.toString(),r.list=location.pathname)}const a=await callShopifyAPI(REMOVE_FROM_CART_MUTATION,{cartId:t,lineIds:[e]}),n=a?.cartLinesRemove?.cart;if(r&&n){const t={event:"dl_remove_from_cart",user_properties:{visitor_type:"guest"},ecommerce:{currencyCode:n.cost?.totalAmount?.currencyCode||"USD",remove:{actionField:{list:location.pathname},products:[r]}}};window.ElevarDataLayer.push(t)}return n}function renderCartItems(){const t=document.getElementById("cart-item-template");if(!(cart&&cart.lines&&cart.lines.nodes&&0!==cart.lines.nodes.length&&t)){emptyCartMessage.classList.remove("hidden"),emptyCartMessage.innerHTML='Your cart is empty.<br><br><a href="#" id="continue-shopping-empty" class="inline-block bg-red-600 text-white text-base font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-red-700 transition duration-300 text-center">Continue Shopping</a>';const t=document.getElementById("continue-shopping-empty");if(t){t.getAttribute("data-listener-added")||(t.addEventListener("click",(t=>{t.preventDefault(),closeDrawer()})),t.setAttribute("data-listener-added","true"))}return}emptyCartMessage.classList.add("hidden");const e=new Set(cart.lines.nodes.map((t=>t.id))),r=cartItemsContainer.querySelectorAll(".cart-item[data-line-id]");new Set(Array.from(r).map((t=>t.getAttribute("data-line-id"))));r.forEach((t=>{const r=t.getAttribute("data-line-id");e.has(r)||t.remove()})),cart.lines.nodes.forEach((e=>{let r=cartItemsContainer.querySelector(`.cart-item[data-line-id="${e.id}"]`);if(r)updateCartItemContent(r,e,!1);else{const a=t.content?.firstElementChild;if(r=a?a.cloneNode(!0):t.cloneNode(!0),r.classList.remove("hidden"),r.removeAttribute("id"),r.setAttribute("data-line-id",e.id),updateCartItemContent(r,e,!0),cartItemsContainer.appendChild(r),window.lucide&&window.lucide.createIcons)try{window.lucide.createIcons({nodes:[r]})}catch(t){console.error("Error creating Lucide icons for new cart item:",t)}}}))}function updateCartItemContent(t,e,r=!1){const a=e.merchandise;r&&(t.querySelector("[data-cart-item-image]").src=a.image?.url||"https://placehold.co/64x64/e2e8f0/94a3b8?text=Item",t.querySelector("[data-cart-item-image]").alt=a.image?.altText||a.product.title,t.querySelector("[data-cart-item-name]").textContent=a.product.title),t.querySelector("[data-cart-item-quantity]").textContent=e.quantity,t.querySelector("[data-cart-item-price]").textContent=`$${parseFloat(e.cost.totalAmount.amount).toFixed(2)}`;const n=t.querySelector("[data-cart-item-original-price]"),o=a.compareAtPrice?parseFloat(a.compareAtPrice.amount):null,i=parseFloat(a.price.amount);if(n)if(o&&o>i){const t=o*e.quantity;n.textContent=`$${t.toFixed(2)}`,n.classList.remove("hidden")}else n.classList.add("hidden");const c=t.querySelector(".quantity-minus-btn");c&&(c.disabled=e.quantity<=0)}function attachCartItemListeners(t,e){const r=e.id,a=t.querySelector(".quantity-minus-btn"),n=t.querySelector(".quantity-plus-btn"),o=t.querySelector(".remove-item-btn");if(a){a.setAttribute("data-line-id",r);const n=a.cloneNode(!0);a.parentNode.replaceChild(n,a),n.addEventListener("click",(()=>{const a=parseInt(t.querySelector("[data-cart-item-quantity]").textContent)||e.quantity;handleUpdateItemQuantity(r,a-1)})),n.disabled=e.quantity<=1}if(n){n.setAttribute("data-line-id",r);const a=n.cloneNode(!0);n.parentNode.replaceChild(a,n),a.addEventListener("click",(()=>{const a=parseInt(t.querySelector("[data-cart-item-quantity]").textContent)||e.quantity;handleUpdateItemQuantity(r,a+1)}))}if(o){o.setAttribute("data-line-id",r);const t=o.cloneNode(!0);o.parentNode.replaceChild(t,o),t.addEventListener("click",handleRemoveItem)}}async function handleRemoveItem(t){const e=t instanceof Event?t.currentTarget:t;let r=e.getAttribute("data-line-id");if(!r){const t=e.closest(".cart-item");r=t?.getAttribute("data-line-id")}if(!cart||!r)return;const a=cartItemsContainer.querySelector(`[data-line-id="${r}"]`);try{const t=await removeCartLine(cart.id,r);t&&(cart=t,a&&a.remove(),renderCartSummary(),renderAppliedDiscounts(),updateCartIconCount())}catch(t){showCartError("Could not remove item. Please try again.")}}async function handleUpdateItemQuantity(t,e){if(!cart||!t)return;cartItemsContainer.querySelector(`[data-line-id="${t}"]`);if(!(e<0))try{let r;if(0===e)r=await removeCartLine(cart.id,t);else{const a=await callShopifyAPI(UPDATE_CART_LINE_MUTATION,{cartId:cart.id,lines:[{id:t,quantity:e}]});r=a?.cartLinesUpdate?.cart}r&&(cart=r,renderCartItems(),renderCartSummary(),renderAppliedDiscounts(),updateCartIconCount())}catch(t){throw showCartError("Could not update item quantity. Please try again."),t}}function updateCartIconCount(){const t=document.getElementById("cart-item-count"),e=document.getElementById("open-cart-trigger"),r=cart?.totalQuantity||0;t&&(t.textContent=r),e&&(e.classList.remove("hidden"),t.classList.toggle("hidden",0===r))}function renderCartSummary(){const t=document.getElementById("installment-info");if(!cart||!cart.lines.nodes.length)return document.getElementById("cart-original-total").textContent="$0.00",document.getElementById("total-savings-amount").textContent="-$0.00",document.getElementById("cart-subtotal").textContent="$0.00",checkoutBtn.setAttribute("data-checkout-url","#"),checkoutBtn.disabled=!0,checkoutBtn.classList.add("opacity-50"),void(t&&(t.innerHTML=""));let e=0,r=0;cart.lines.nodes.forEach((t=>{const a=t.merchandise,n=t.quantity,o=a.compareAtPrice?parseFloat(a.compareAtPrice.amount):null,i=parseFloat(a.price.amount);e+=(o&&o>i?o:i)*n,r+=i*n}));const a=r,n=e-a;if(document.getElementById("cart-original-total").textContent=`$${e.toFixed(2)}`,document.getElementById("total-savings-amount").textContent=`-$${n.toFixed(2)}`,document.getElementById("cart-subtotal").textContent=`$${a.toFixed(2)}`,checkoutBtn.disabled=0===a,checkoutBtn.classList.toggle("opacity-50",0===a),checkoutBtn.setAttribute("data-checkout-url",cart.checkoutUrl||"#"),t)if(a>0){const e=(a/4).toFixed(2),r=t.querySelector("b");if(r)r.textContent!==`$${e}`&&(r.textContent=`$${e}`);else{const r="https://res.cloudinary.com/dg8ibuag5/image/upload/v1743723089/Shop_Pay_logo_purple_xqxhd1.svg";t.innerHTML=`\n                        or 4 interest-free payments of <b>$${e}</b> with\n                        <img src="${r}" alt="Shop Pay" class="inline-block h-4 ml-1 align-middle" loading="lazy">\n                    `}}else t.innerHTML=""}function renderAppliedDiscounts(){let t=null,e=0,r="";try{t=localStorage.getItem(ALIA_CODE_STORAGE_KEY);const a=localStorage.getItem(ALIA_EXPIRY_STORAGE_KEY);e=a?parseInt(a):0,r=localStorage.getItem(ALIA_TEXT_STORAGE_KEY)||""}catch(t){console.warn("LocalStorage access error when getting Alia discount data:",t)}const a=t&&e&&e>Date.now(),n=cart?.discountCodes?.some((e=>e.code===t));if(a&&n)aliaRewardTextElement.textContent=r||"Discount Applied",aliaDiscountCodeElement.textContent=t,aliaDiscountSection.classList.remove("hidden"),startAliaTimer(Math.floor((e-Date.now())/1e3));else if(aliaDiscountSection.classList.add("hidden"),aliaExpiredMessageElement&&aliaExpiredMessageElement.classList.add("hidden"),clearInterval(aliaTimerInterval),t&&e&&e<=Date.now())try{localStorage.removeItem(ALIA_CODE_STORAGE_KEY),localStorage.removeItem(ALIA_TEXT_STORAGE_KEY),localStorage.removeItem(ALIA_EXPIRY_STORAGE_KEY)}catch(t){console.warn("LocalStorage access error when removing expired Alia data:",t)}}function startAliaTimer(t){if(clearInterval(aliaTimerInterval),t<=0){aliaTimerElement.textContent="Expired",aliaDiscountSection.classList.add("opacity-50");try{localStorage.removeItem(ALIA_CODE_STORAGE_KEY),localStorage.removeItem(ALIA_TEXT_STORAGE_KEY),localStorage.removeItem(ALIA_EXPIRY_STORAGE_KEY)}catch(t){console.warn("LocalStorage access error when removing expired Alia data in timer:",t)}return void fetchCart(cart?.id).then((t=>{t?(cart=t,renderCart()):initializeCart()})).catch((t=>{renderCart()}))}aliaDiscountSection.classList.remove("opacity-50");let e=t;const r=()=>{const t=Math.floor(e/60),r=e%60;aliaTimerElement.textContent=`${t}:${r<10?"0":""}${r}`};r(),aliaTimerInterval=setInterval((()=>{if(e--,r(),e<0){clearInterval(aliaTimerInterval),aliaTimerElement.textContent="Expired",aliaDiscountSection.classList.add("opacity-50");try{localStorage.removeItem(ALIA_CODE_STORAGE_KEY),localStorage.removeItem(ALIA_TEXT_STORAGE_KEY),localStorage.removeItem(ALIA_EXPIRY_STORAGE_KEY)}catch(t){console.warn("LocalStorage access error when removing expired Alia data after timer expiry:",t)}cart?.id?applyDiscountCode(cart.id).then((t=>{t?(cart=t,renderCart(),aliaExpiredMessageElement&&aliaExpiredMessageElement.classList.remove("hidden")):initializeCart()})).catch((t=>{renderCart(),aliaExpiredMessageElement&&aliaExpiredMessageElement.classList.remove("hidden")})):(renderCart(),aliaExpiredMessageElement&&aliaExpiredMessageElement.classList.remove("hidden"))}}),1e3)}function renderCart(){renderCartItems(),renderCartSummary(),renderAppliedDiscounts();const t=document.getElementById("open-cart-trigger"),e=document.getElementById("cart-item-count"),r=cart?.totalQuantity||0;t&&e&&(e.textContent=r,t.classList.remove("hidden"),e.classList.toggle("hidden",0===r)),setLoading(!1)}function openDrawer(){if(cartDrawer&&cartOverlay&&(previousActiveElement=document.activeElement,cartOverlay.classList.remove("hidden","pointer-events-none"),cartOverlay.classList.add("pointer-events-auto"),setTimeout((()=>cartOverlay.classList.add("opacity-100")),10),cartDrawer.classList.remove("translate-x-full"),cartDrawer.classList.add("translate-x-0"),cartDrawer.setAttribute("aria-hidden","false"),document.documentElement.classList.add("cart-drawer-open"),setTimeout((()=>{const t=cartDrawer.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');t.length>0&&t[0].focus(),cartDrawer.addEventListener("keydown",handleFocusTrap)}),10),cart&&(renderCart(),window.ElevarDataLayer&&cart.lines&&cart.lines.nodes.length>0))){const t=cart.lines.nodes.map(((t,e)=>createElevarImpressionObj(t,e)));let e=cart?.cost?.totalAmount?.amount,r=0;try{if("number"==typeof e)r=Number.isInteger(e)?e:Math.round(100*e);else if("string"==typeof e){const t=parseFloat(e);isNaN(t)||(r=e.includes(".")?Math.round(100*t):parseInt(e,10))}}catch(t){console.warn("[Elevar ViewCart] Error processing cart total:",e,t)}const a={event:"dl_view_cart",user_properties:{visitor_type:"guest"},cart_total:(r/100).toFixed(2),ecommerce:{currencyCode:cart.cost?.totalAmount?.currencyCode||"USD",actionField:{list:location.pathname},impressions:t}};window.ElevarDataLayer.push(a)}}function closeDrawer(){cartDrawer&&cartOverlay&&(cartOverlay.classList.remove("opacity-100"),cartOverlay.classList.remove("pointer-events-auto"),cartOverlay.classList.add("pointer-events-none"),setTimeout((()=>cartOverlay.classList.add("hidden")),300),cartDrawer.classList.remove("translate-x-0"),cartDrawer.classList.add("translate-x-full"),document.documentElement.classList.remove("cart-drawer-open"),cartDrawer.setAttribute("aria-hidden","true"),cartDrawer.removeEventListener("keydown",handleFocusTrap),previousActiveElement&&(previousActiveElement.focus(),previousActiveElement=null),hideCartError())}async function initializeCart(){try{if(!await getOrCreateCart())return void setLoading(!1);initializeElevar(),await updateBundlePrices()}catch(t){showCartError("An unexpected error occurred while initializing the cart.")}finally{renderCart(),setLoading(!1)}}async function handleAddItemClick(t){if(!t)return;let e=cart?.id;if(e||(await initializeCart(),e=cart?.id,e))try{const r=await addCartLine(e,t,1);if(r){const e=r.lines.nodes.find((e=>e.merchandise.id===t));if(e){const t=e.merchandise,a=(parseFloat(t.price.amount),t.product.title,t.id,r.lines.nodes.map((t=>{const e=t.merchandise;return{ProductID:e.id,Name:e.product.title,Quantity:t.quantity,ItemPrice:parseFloat(e.price.amount),RowTotal:parseFloat(t.cost.totalAmount.amount),ImageURL:e.image?.url,URL:window.location.origin+window.location.pathname,Categories:[],Brand:"TryLumiClean",VariantName:e.title}}))),n={total_price:parseFloat(r.cost.totalAmount.amount),$value:parseFloat(r.cost.totalAmount.amount),original_total_price:parseFloat(r.cost.subtotalAmount.amount),items:a};(window._learnq||[]).push(["track","Added to Cart",n])}cart=r,renderCart(),openDrawer()}}catch(t){t.message.includes("Inventory")||t.message.includes("stock")?showCartError(`Could not add item: ${t.message}`):showCartError("Could not add item to cart. Please try again."),renderCart()}else alert("Could not initialize cart. Please try again.")}function setupEventListeners(){const t=document.getElementById("open-cart-trigger");t&&t.addEventListener("click",openDrawer),closeCartBtn.addEventListener("click",closeDrawer),cartOverlay.addEventListener("click",closeDrawer);const e=document.getElementById("continue-shopping-btn");e&&e.addEventListener("click",closeDrawer),checkoutBtn.addEventListener("click",(()=>{const t=cart?.checkoutUrl;if(window.checkoutResetTimeout&&(clearTimeout(window.checkoutResetTimeout),window.checkoutResetTimeout=null),cart&&cart.totalQuantity>0&&t&&"#"!==t){checkoutBtn.disabled=!0,checkoutBtn.classList.add("opacity-50"),checkoutBtn.textContent="Redirecting...";const e=getUrlParameters(),r=new URLSearchParams;e.forEach((t=>{t.value&&r.append(t.key,t.value)}));const a=r.toString();let n=t;a&&(t.includes("?")?n+="&"+a:n+="?"+a),console.log("Redirecting to checkout with params:",n),window.location.href=n,window.checkoutResetTimeout=setTimeout((()=>{checkoutBtn.disabled=!1,checkoutBtn.classList.remove("opacity-50"),checkoutBtn.textContent="Proceed to Checkout",window.checkoutResetTimeout=null}),5e3)}else if(cart&&0===cart.totalQuantity){showCartError(cart?.discountCodes&&cart.discountCodes.length>0?"Please add products to your cart to use your discount.":"Your cart is empty."),checkoutBtn.disabled=!0,checkoutBtn.classList.add("opacity-50"),checkoutBtn.textContent="Proceed to Checkout"}else console.error("Checkout URL not available or cart invalid."),showCartError("Could not proceed to checkout. Please try again later."),checkoutBtn.disabled=!1,checkoutBtn.classList.remove("opacity-50"),checkoutBtn.textContent="Proceed to Checkout"})),document.querySelectorAll(".js-main-cta").forEach((t=>{t.addEventListener("click",(t=>{t.preventDefault();const e=getSelectedVariantId(),r=cart?.lines?.nodes?.some((t=>t.merchandise.id===e));r?(console.log("Product already in cart, opening drawer."),openDrawer()):(console.log(`Product not in cart, adding variant ${e}...`),handleAddItemClick(e))}))})),document.querySelectorAll('input[name="bundle"]').forEach((t=>{t.addEventListener("change",(()=>{document.querySelectorAll("label[data-variant-id]").forEach((t=>{t.classList.remove("border-[#1f7bcc]"),t.querySelector('input[name="bundle"]:checked')&&t.classList.add("border-[#1f7bcc]")})),console.log(`Bundle selection changed to: ${getSelectedVariantId()}`)}))})),cartItemsContainer.addEventListener("click",(function(t){const e=t.target.closest(".quantity-minus-btn");if(e){const t=e.closest(".cart-item"),r=t?.getAttribute("data-line-id");return void optimisticLineQuantityChange(t,r,-1)}const r=t.target.closest(".quantity-plus-btn");if(r){const t=r.closest(".cart-item"),e=t?.getAttribute("data-line-id");return void optimisticLineQuantityChange(t,e,1)}const a=t.target.closest(".remove-item-btn");a&&handleRemoveItem(a)})),window.addEventListener("pagehide",(()=>{window.checkoutResetTimeout&&(clearTimeout(window.checkoutResetTimeout),window.checkoutResetTimeout=null)})),document.addEventListener("alia:rewardClaimed",(async t=>{if(isLoading)return;const{rewardText:e,discountCode:r}=t.detail;if(!r)return;const a=Date.now()+18e5;if(!cart)try{if(await initializeCart(),!cart)throw new Error("Failed to create cart after Alia event.")}catch(t){return void showCartError("Could not initialize cart to apply discount.")}try{const t=await applyDiscountCode(cart.id,r);if(!t)throw new Error("Failed to update cart with discount code.");{const n=t.discountCodes?.some((t=>t.code===r));if(!n)throw new Error("Discount code was not applied successfully by Shopify.");try{localStorage.setItem(ALIA_CODE_STORAGE_KEY,r),localStorage.setItem(ALIA_TEXT_STORAGE_KEY,e),localStorage.setItem(ALIA_EXPIRY_STORAGE_KEY,a.toString())}catch(t){console.warn("LocalStorage access error when saving Alia discount data:",t)}cart=t,renderCart(),openDrawer()}}catch(t){showCartError(`Could not apply discount: ${t.message}`);try{localStorage.removeItem(ALIA_CODE_STORAGE_KEY),localStorage.removeItem(ALIA_TEXT_STORAGE_KEY),localStorage.removeItem(ALIA_EXPIRY_STORAGE_KEY)}catch(t){console.warn("LocalStorage access error when removing Alia data after application error:",t)}renderAppliedDiscounts()}})),document.addEventListener("alia:signup",(async t=>{if(isLoading)return;const{email:e,phone:r}=t.detail;if(!e&&!r)return;if(!cart)try{if(cart=await getOrCreateCart(),!cart)throw new Error("Failed to create cart for signup event.")}catch(t){return void showCartError("Could not initialize cart to save contact info.")}const a={};e&&(a.email=e),r&&(a.phone=r);try{const t=await callShopifyAPI(CART_BUYER_IDENTITY_UPDATE_MUTATION,{cartId:cart.id,buyerIdentity:a});if(!t?.cartBuyerIdentityUpdate?.cart)throw new Error(t?.cartBuyerIdentityUpdate?.userErrors?.[0]?.message||"Unknown error updating buyer identity.");cart=t.cartBuyerIdentityUpdate.cart}catch(t){showCartError(`Could not save contact information: ${t.message}`)}})),document.addEventListener("alia:pollAnswered",(async t=>{if(isLoading)return;const{answers:e}=t.detail;if(!e||0===e.length)return;if(!cart)try{if(cart=await getOrCreateCart(),!cart)throw new Error("Failed to create cart for poll event.")}catch(t){return void showCartError("Could not initialize cart to save poll answers.")}const r=e.map((t=>({key:`poll_${t.questionID||"question"}`,value:`${t.questionText}: ${t.answerText}`}))).filter((t=>!(t.key.length>100||t.value.length>255)));if(0===r.length)return;const a=[...(cart&&Array.isArray(cart.attributes)?cart.attributes:[]).filter((t=>!t.key.startsWith("poll_"))),...r];try{const t=await callShopifyAPI(CART_ATTRIBUTES_UPDATE_MUTATION,{cartId:cart.id,attributes:a});if(!t?.cartAttributesUpdate?.cart)throw new Error(t?.cartAttributesUpdate?.userErrors?.[0]?.message||"Unknown error updating cart attributes.");cart=t.cartAttributesUpdate.cart}catch(t){showCartError(`Could not save poll answers: ${t.message}`)}}))}async function bootstrapCart(){initializeLucideIcons();try{await initializeCart()}catch(t){}setupEventListeners()}function initializeLucideIcons(){if(void 0!==window.lucide&&window.lucide.icons)try{const t={attrs:{"stroke-width":"1.5",stroke:"currentColor"}};window.lucide.icons&&Object.keys(window.lucide.icons).length&&(t.icons=window.lucide.icons),window.lucide.createIcons(t)}catch(t){}}window.mfunc=window.mfunc||[],"loading"===document.readyState?document.addEventListener("DOMContentLoaded",bootstrapCart,{once:!0}):bootstrapCart();const productCache={};async function fetchProductData(t){if(productCache[t])return productCache[t];try{const e=await callShopifyAPI("\n            query getVariantById($id: ID!) {\n                node(id: $id) {\n                    ... on ProductVariant {\n                        id\n                        title\n                        price {\n                            amount\n                            currencyCode\n                        }\n                        compareAtPrice {\n                            amount\n                            currencyCode\n                        }\n                        image {\n                            url\n                            altText\n                        }\n                        product {\n                            id\n                            title\n                            description\n                            images(first: 1) {\n                                edges {\n                                    node {\n                                        url\n                                        altText\n                                    }\n                                }\n                            }\n                        }\n                    }\n                }\n            }\n        ",{id:t});return e&&e.node?(productCache[t]=e.node,e.node):null}catch(t){return null}}async function updateBundlePrices(){const t=document.querySelectorAll("label[data-variant-id]");for(const e of t){const t=e.getAttribute("data-variant-id");if(t)try{const r=e.querySelector("p.font-bold"),a=e.querySelector("p.line-through");r&&(r.innerHTML='<span class="inline-block animate-pulse">Loading...</span>');const n=await fetchProductData(t);if(n){if(r&&n.price){const t=parseFloat(n.price.amount),e=n.price.currencyCode||"USD";r.textContent=formatPrice(t,e)}if(a&&n.compareAtPrice){const t=parseFloat(n.compareAtPrice.amount),e=n.compareAtPrice.currencyCode||"USD";a.textContent=formatPrice(t,e)}const t=e.querySelector("img");if(t&&n.image&&n.image.url){const e=t.src;t.onerror=()=>{t.src=e},t.src=n.image.url,t.alt=n.image.altText||n.product?.title||"TryLumiClean Bundle Option"}}}catch(t){}}}function formatPrice(t,e="USD"){let r=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"});return"AED"===e&&(r=new Intl.NumberFormat("en-AE",{style:"currency",currency:"AED"})),r.format(t)}function toggleLineButtons(t,e){t&&t.querySelectorAll(".quantity-btn").forEach((t=>t.disabled=e))}async function optimisticLineQuantityChange(t,e,r){if(!t||!e)return;const a=t.querySelector("[data-cart-item-quantity]"),n=parseInt(a.textContent)||0,o=n+r;if(o<0)return;if(0===o){const r=t.closest(".cart-item");r&&r.remove(),toggleLineButtons(t,!0);try{await handleUpdateItemQuantity(e,0)}catch(t){renderCart()}return}a.textContent=o;const i=t.querySelector(".quantity-minus-btn");i&&(i.disabled=o<=0),toggleLineButtons(t,!0);try{await handleUpdateItemQuantity(e,o)}catch(e){a.textContent=n,toggleLineButtons(t,!1),i&&(i.disabled=n<=0)}}async function applyDiscountCode(t,e=null){if(!t)throw console.error("Cannot apply discount: Cart ID is missing."),new Error("Cart ID is missing.");const r=e?Array.isArray(e)?e:[e]:[];console.log(`Applying discount codes: ${r.join(", ")||"REMOVING ALL"} to cart ${t}`);try{const e=await callShopifyAPI(UPDATE_DISCOUNT_CODE_MUTATION,{cartId:t,discountCodes:r}),a=e?.cartDiscountCodesUpdate?.cart,n=e?.cartDiscountCodesUpdate?.userErrors;if(n&&n.length>0)throw console.error("Shopify Discount Error:",n),new Error(n[0].message);if(!a)throw console.error("Failed to update cart with discount code, no updated cart returned."),new Error("Failed to update cart with discount code.");return console.log(`Discount update successful for cart ${t}. Applied codes:`,a.discountCodes.map((t=>t.code))),a}catch(t){throw console.error("Error applying/removing discount code:",t),t}}function handleFocusTrap(t){if("Tab"!==t.key)return;const e=cartDrawer.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');if(0===e.length)return;const r=e[0],a=e[e.length-1];t.shiftKey?document.activeElement===r&&(a.focus(),t.preventDefault()):document.activeElement===a&&(r.focus(),t.preventDefault())}